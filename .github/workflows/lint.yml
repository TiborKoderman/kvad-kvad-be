name: Lint & Format

on:
    push:
        branches: ["main", "master"]
    pull_request:
        paths:
            - "**/*.cs"
            - ".editorconfig"
            - "Directory.Build.props"

jobs:
    restore-and-lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0.x"

            - name: Restore dotnet tools
              run: dotnet tool restore --tool-manifest .config/dotnet-tools.json

            - name: Install dependencies
              run: dotnet restore

            - name: Ensure dotnet-format is available
              run: |
                  if ! dotnet tool list -g | grep -q dotnet-format; then
                    dotnet tool install -g dotnet-format --version 6.0.264601; 
                  fi

            - name: Run dotnet-format (verify)
              run: dotnet format --verify-no-changes

            - name: Build (with analyzers)
              run: dotnet build -p:EnableNETAnalyzers=true --no-restore
